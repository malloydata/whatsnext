# WN 0012 - Timestamp Types in Malloy

- **Status**: *Accepted*
- **Discussions-To:** _TBD_
- **Author:** Michael Toy [mtoy@google.com][1]
- **Experiment-ID: Â **_none_

# Time Types in Malloy

Time is immensely complicated. Malloy presents a simplified model of time datatypes. If your application requires precise time handling with detailed behaviors around leap seconds or other edge cases, you are encouraged to use database-provided time functions and consult the database manuals.

We believe that for most users, the Malloy time abstractions will be sufficient.

## Four Kinds of Time Data

There are four conceptual kinds of time data:

1. **Civil dates** - A calendar date without time-of-day (e.g., `2021-02-24`)
2. **Civil timestamps** - A date and time as an observer would describe it, without reference to an absolute instant (e.g., `2021-02-24 00:00:00` - which midnight depends on where you are)
3. **Instant timestamps** - An absolute moment in time, stored without timezone metadata
4. **Instant timestamptz** - An absolute moment in time, stored with timezone offset information

## Malloy's Three Time Types

Malloy supports three of these four kinds:

- **`date`** - Represents civil dates
- **`timestamp`** - Represents instant timestamps
- **`timestamptz`** - Represents instant timestamptz

Both `timestamp` and `timestamptz` work interchangeably in Malloy and have identical semantics. The distinction exists to support different database column storage formats.

### Why No Civil Timestamp Type?

Malloy does not have a civil timestamp type because only BigQuery has a database column type (DATETIME) that stores civil timestamps differently from instant timestamps. Since this type exists in only one database, it remains unsupported in Malloy for the foreseeable future.

While some databases can achieve civil-time-like behavior through session timezone settings on their timestamp columns, **Malloy interprets all TIMESTAMP columns with instant/epoch semantics**, regardless of the underlying database's session timezone behavior.

## Query Timezone

Malloy supports a "query timezone" which determines how timestamps are truncated, extracted, and rendered. The default query timezone is UTC, but queries can specify a timezone:

```malloy
query: myQuery -> {
  timezone: 'America/Los_Angeles'
  // operations happen in Los Angeles time
}
```

As the query timezone changes, the truncation and extraction of timestamps will change to match. The handling of dates is unaffected by query timezone settings.

## Time Operations

### Truncation

Truncation in Malloy is written `(expression).unitName`:

```malloy
my_timestamp.day    // Truncate to day
my_timestamp.hour   // Truncate to hour
```

Truncation happens in the query timezone (default UTC).

### Extraction

Extraction in Malloy is written `unitName(expression)`:

```malloy
day(my_timestamp)      // Extract day of month
hour(my_timestamp)     // Extract hour
```

Extraction happens in the query timezone (default UTC).

### Measurement

Malloy allows intervals to be measured in units:

```malloy
hours(start_time to end_time)   // Measure hours between
```

### Casting

Types can be cast using the `::` operator:

```malloy
my_date::timestamp        // Date to timestamp
my_timestamp::date        // Timestamp to date
my_timestamp::timestamptz // Timestamp to timestamptz
```

See the documentation for detailed casting semantics with query timezones.

## Mapping Database Types to Malloy Types

| Database         | Column Type              | Malloy Type | Notes                      |
| ---------------- | ------------------------ | ----------- | -------------------------- |
| **BigQuery**     | DATETIME                 | unsupported | Civil timestamp type       |
|                  | TIMESTAMP                | timestamp   | Instant time               |
|                  | DATE                     | date        |                            |
| **PostgreSQL**   | TIMESTAMP                | timestamp   | Interpreted as instant     |
|                  | TIMESTAMPTZ              | timestamptz | Instant with offset        |
|                  | DATE                     | date        |                            |
| **DuckDB**       | TIMESTAMP                | timestamp   | Interpreted as instant     |
|                  | TIMESTAMPTZ              | timestamptz | Instant with offset        |
|                  | DATE                     | date        |                            |
| **Snowflake**    | TIMESTAMP\_NTZ           | timestamp   | No timezone info           |
|                  | TIMESTAMP\_LTZ           | unsupported | Session timezone dependent |
|                  | TIMESTAMP\_TZ            | timestamptz | Instant with offset        |
|                  | DATE                     | date        |                            |
| **Trino/Presto** | TIMESTAMP                | timestamp   | Instant time               |
|                  | TIMESTAMP WITH TIME ZONE | timestamptz | Instant with offset        |
|                  | DATE                     | date        |                            |

## Timestamp Literals

Timestamp literals are specified with the `@` character:

```malloy
@2001-02-03 04:05:06        // Plain timestamp
@2001-02-03 04:05:06[UTC]   // Timestamptz (on supporting databases)
```

On databases that support `timestamptz`, embedding a timezone in a literal produces a `timestamptz` value. On databases without `timestamptz` support, the timezone is used to compute the correct instant, but the result is a plain `timestamp`.

## Unsupported Time Types

- **BigQuery DATETIME** - Civil timestamp type that exists only in BigQuery
- **Intervals** - There is no support in Malloy for interval values as a data type. You can measure intervals and store the measurement result as a number.

## Implementation Notes

Malloy makes no guarantees about leap second accuracy in any of its operations. The time space for Malloy operations may be off by a leap second in cases where that matters.

There is no way in Malloy to specify a timezone except when defining a literal or when setting the query timezone. You can access timezone-related functions through the native function interface if the database provides them.

[1]:	mailto:the.michael.toy@gmail.com
