# WN 0023 - Malloy Shared Configuration

- **Status**: *Draft*
- **Discussions-To:** TBD
- **Author:** Michael Toy

## Overview

Malloy tools — the VSCode extension, the builder CLI, and potentially others — need to agree on database connection configurations. This WN defines a shared configuration file format for that purpose.

The configuration file defines named database connections and optionally defines **modes** — named environment variants that override connection settings. It uses the MOTLY (Malloy Tag Language) format because it is hand-edited by developers and MOTLY is cleaner than JSON for that purpose.

This file is not a core Malloy concept. The Malloy runtime takes connections as arguments and does not read configuration files. This file is a convention shared between tools that wrap the runtime.

## The Configuration File

The configuration file is named `malloy-config.motly`. It uses the MOTLY (Malloy Tag Language) format.

A minimal configuration declares one connection:

```motly
Connections: {
  duckdb: {
    type: duckdb
  }
}
```

A more complete example:

```motly
Connections: {
  warehouse: {
    type: bigquery
    defaultProjectId: "${GCP_PROJECT}"
    location: US
  }
  logs: {
    type: postgres
    host: "${PG_HOST}"
    port: 5432
    databaseName: analytics
    userName: "${PG_USER}"
    password: "${PG_PASSWORD}"
  }
  local: {
    type: duckdb
  }
}

Modes: {
  user: {
    Connections: {
      warehouse: {
        type: duckdb
        path: "./data/warehouse-sample.db"
      }
      logs: {
        type: duckdb
        path: "./data/logs-sample.db"
      }
    }
  }
  staging: {
    Connections: {
      warehouse: {
        defaultProjectId: "${GCP_PROJECT}"
        dataset: staging_analytics
      }
      logs: {
        host: "${STAGING_PG_HOST}"
      }
    }
  }
  production: {
  }
}
```

### MOTLY Conventions

The configuration file follows these MOTLY conventions:

- **Capitalized names** are structural keywords: `Connections:`, `Modes:`
- **Lowercase names** are user-defined: `warehouse:`, `staging:`, `local:`
- **Braces** denote something with properties: `name: { ... }`
- **Quoted strings** for values containing anything beyond alphanumeric characters and underscores: `"${GCP_PROJECT}"`, `"./data/local.db"`
- **Unquoted strings** for simple identifiers: `bigquery`, `duckdb`, `US`

## Connections

The `Connections:` section declares named database connections. Malloy models reference connections by name (e.g., `source: foo is warehouse.table('orders')`), and the configuration file provides the actual settings for each name.

### Connection Types

Connection configurations follow the same schema used by the Malloy Publisher application. Each connection has a `type` and type-specific properties:

| Type | Key Properties |
|------|----------------|
| `duckdb` | `path`, attached databases |
| `bigquery` | `defaultProjectId`, `billingProjectId`, `location`, `serviceAccountKeyJson` |
| `postgres` | `host`, `port`, `databaseName`, `userName`, `password` (or `connectionString`) |
| `snowflake` | `account`, `username`, `password`/`privateKey`, `warehouse`, `database`, `schema` |
| `trino` | `server`, `port`, `catalog`, `schema`, `user`, `password` |
| `mysql` | `host`, `port`, `database`, `user`, `password` |
| `motherduck` | `accessToken`, `database` |

DuckDB connections can also attach external databases (BigQuery, Snowflake, Postgres, S3, GCS) as named databases, following the existing DuckDB attached-databases pattern.

### Environment Variable Substitution

All string values support `${VAR_NAME}` substitution. The variable must exist in the environment or the configuration file fails to load. This is the mechanism for keeping secrets out of the file.

```motly
Connections: {
  warehouse: {
    type: bigquery
    defaultProjectId: "${GCP_PROJECT}"
    serviceAccountKeyJson: "${BQ_SERVICE_ACCOUNT_KEY}"
  }
}
```

## Modes

The `Modes:` section defines named configurations that override connection settings. A mode allows the same Malloy models to run against different databases depending on the context — local development, staging, production, or any other environment a team defines.

### How Modes Work

Each mode can override any connection declared in the top-level `Connections:` section. Overrides can be full replacements (changing the connection type entirely) or partial patches (changing just one property):

```motly
Modes: {
  user: {
    Connections: {
      // Full replacement: BigQuery → local DuckDB
      warehouse: {
        type: duckdb
        path: "./data/warehouse-sample.db"
      }
    }
  }
  staging: {
    Connections: {
      // Partial override: same type, different dataset
      warehouse: {
        dataset: staging_analytics
      }
    }
  }
}
```

Connections not mentioned in a mode inherit from the top-level `Connections:` section unchanged.

### Mode Selection

The configuration file declares what modes **exist**. Which mode is **active** is determined by the application:

- **VSCode extension**: Mode picker in the status bar or settings
- **CLI tools**: `--mode` flag (e.g., `malloy build --mode staging`)
- **Default**: When no mode is specified, the top-level connections are used directly

The configuration file does not specify a default mode. Applications may have their own default behavior.

### Modes Are User-Defined

Modes are not a fixed set. A configuration defines whatever modes make sense for its workflow. A small project might have no modes at all. A large organization might have:

```motly
Modes: {
  user: { ... }
  team_staging: { ... }
  corp_staging: { ... }
  production: { ... }
}
```

Adding a new mode is just adding a new block to the file.

## How Applications Use This File

### VSCode Extension

The VSCode extension reads `malloy-config.motly` for connection definitions, replacing or supplementing its current connection settings. It discovers the file by searching upward from the current directory. Mode selection is a VSCode setting (status bar picker or workspace settings).

### Builder CLI

The builder CLI reads the same file for connections:

```
malloy build pipeline.malloy              # Uses default connections
malloy build --mode staging .             # Uses staging mode connections
```

### Publisher and Other Applications

Applications with their own connection management (like Malloy Publisher) are not required to read this file. They may:

- Ignore it entirely and use their own configuration
- Generate one when they need the builder or VSCode to work with the same connections
- Read it as a convenience

The file is a shared convention, not a requirement.

## Future Considerations

- **Connection indirection**: A future mechanism could allow the configuration file to import connections from an external source (another file, a URL) rather than defining them inline. This would support scenarios where connection definitions are managed centrally.
