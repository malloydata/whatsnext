# WN 0023 - Malloy Projects

- **Status**: *Draft*
- **Discussions-To:** TBD
- **Author:** Michael Toy

## Overview

A Malloy project is a directory tree of `.malloy` files (models) anchored by a project configuration file at the root. The project file defines what database connections are available to models in the project, and optionally defines **modes** that allow the same models to run against different connection configurations.

The project file is the single configuration artifact shared across all tools that work with Malloy: the VSCode extension, the command-line tools, builder applications, and any future tooling. Its location defines the project root, similar to how `package.json` defines an npm package root.

## The Project File

The project file is named `malloy-project.motly` and lives at the root of the project. It uses the MOTLY (Malloy Tag Language) format.

A minimal project file declares one connection:

```motly
Connections: {
  duckdb: {
    type: duckdb
  }
}
```

A more complete example:

```motly
Connections: {
  warehouse: {
    type: bigquery
    defaultProjectId: "${GCP_PROJECT}"
    location: US
  }
  logs: {
    type: postgres
    host: "${PG_HOST}"
    port: 5432
    databaseName: analytics
    userName: "${PG_USER}"
    password: "${PG_PASSWORD}"
  }
  local: {
    type: duckdb
  }
}

Modes: {
  user: {
    Connections: {
      warehouse: {
        type: duckdb
        path: "./data/warehouse-sample.db"
      }
      logs: {
        type: duckdb
        path: "./data/logs-sample.db"
      }
    }
  }
  staging: {
    Connections: {
      warehouse: {
        defaultProjectId: "${GCP_PROJECT}"
        dataset: staging_analytics
      }
      logs: {
        host: "${STAGING_PG_HOST}"
      }
    }
  }
  production: {
  }
}
```

## Connections

The `Connections:` section declares the named database connections available to models in the project. A model references connections by name (e.g., `source: foo is warehouse.table('orders')`), and the project file provides the actual configuration for each name.

### Connection Types

Connection configurations follow the same schema used by the Malloy Publisher application. Each connection has a `type` and type-specific properties:

| Type | Key Properties |
|------|----------------|
| `duckdb` | `path`, attached databases |
| `bigquery` | `defaultProjectId`, `billingProjectId`, `location`, `serviceAccountKeyJson` |
| `postgres` | `host`, `port`, `databaseName`, `userName`, `password` (or `connectionString`) |
| `snowflake` | `account`, `username`, `password`/`privateKey`, `warehouse`, `database`, `schema` |
| `trino` | `server`, `port`, `catalog`, `schema`, `user`, `password` |
| `mysql` | `host`, `port`, `database`, `user`, `password` |
| `motherduck` | `accessToken`, `database` |

DuckDB connections can also attach external databases (BigQuery, Snowflake, Postgres, S3, GCS) as named databases, following the existing DuckDB attached-databases pattern.

### Environment Variable Substitution

All string values support `${VAR_NAME}` substitution. The variable must exist in the environment or the project file fails to load. This is the mechanism for keeping secrets out of the project file.

```motly
Connections: {
  warehouse: {
    type: bigquery
    defaultProjectId: "${GCP_PROJECT}"
    serviceAccountKeyJson: "${BQ_SERVICE_ACCOUNT_KEY}"
  }
}
```

## Modes

The `Modes:` section defines named configurations that override connection settings. A mode allows the same Malloy models to run against different databases depending on the context — local development, staging, production, or any other environment a team defines.

### How Modes Work

Each mode can override any connection declared in the top-level `Connections:` section. Overrides can be full replacements (changing the connection type entirely) or partial patches (changing just one property):

```motly
Modes: {
  user: {
    Connections: {
      // Full replacement: BigQuery → local DuckDB
      warehouse: {
        type: duckdb
        path: "./data/warehouse-sample.db"
      }
    }
  }
  staging: {
    Connections: {
      // Partial override: same type, different dataset
      warehouse: {
        dataset: staging_analytics
      }
    }
  }
}
```

Connections not mentioned in a mode inherit from the top-level `Connections:` section unchanged.

### Mode Selection

The project file declares what modes **exist**. Which mode is **active** is determined by the application:

- **VSCode extension**: Mode picker in the status bar or settings
- **CLI tools**: `--mode` flag (e.g., `malloy build --mode staging`)
- **Default**: When no mode is specified, the top-level connections are used directly

The project file does not specify a default mode. Applications may have their own default behavior.

### Modes Are User-Defined

Modes are not a fixed set. A project defines whatever modes make sense for its workflow. A small project might have no modes at all. A large organization might have:

```motly
Modes: {
  user: { ... }
  team_staging: { ... }
  corp_staging: { ... }
  production: { ... }
}
```

Adding a new mode is just adding a new block to the project file.

### Modes Beyond Persistence

Modes are a general project concept, not specific to persistence. Even a project with no `#@ persist` annotations benefits from modes if developers want to work against local databases while production runs against cloud infrastructure. However, modes interact naturally with persistence (see WN-0022):

- Each mode has its own set of manifests at `.malloy/manifests/<mode>/`
- BuildIDs may differ across modes if connection digests differ
- Applications can configure persistence behavior (like `strictPersist`) per mode

## Project Structure

A project encompasses all files under the project root:

```
myproject/
  malloy-project.motly          ← project file (project root)
  pipeline.malloy
  analytics/
    dashboard.malloy
    reports.malloy
  data/
    sample.parquet
  .malloy/                      ← generated artifacts (may be partially gitignored)
    manifests/
      user/                     ← per-mode manifest directories
        pipeline.manifest.json
        analytics/
          dashboard.manifest.json
      staging/
        ...
      production/
        ...
```

### Rules

- The project root is the directory containing `malloy-project.motly`
- All `.malloy` files under the root are part of the project
- Generated artifacts live under `.malloy/` by convention
- Manifests mirror the model tree structure under `.malloy/manifests/<mode>/`

### .gitignore

Which manifests to commit is a team decision. A typical pattern:

```
# Development manifests — per-developer, not shared
.malloy/manifests/user/
```

Staging and production manifests may be committed to the repository since they represent shared build state.

## CLI Interaction

The project file enables command-line workflows:

```
malloy init                          # Create a new project file
malloy build pipeline.malloy         # Build persist sources (uses default connections)
malloy build --mode staging .        # Build all models in staging mode
malloy gc --mode staging             # Clean up orphaned manifests and tables
```

The CLI discovers the project file by searching upward from the current directory, like `git` finds `.git`.

## Future Considerations

The project file is designed to grow without breaking existing configurations:

- **Packages**: A future `Packages:` section could describe how a project exports models for use by other projects, or references external model packages (similar to npm packages/workspaces).
- **Nested projects**: Projects could nest, with a child project's config file defining a sub-project boundary, analogous to npm workspaces.
- **Build configuration**: A future section could hold default builder settings, persistence strategies, or scheduling hints.

These additions would be new top-level sections in the project file. Existing project files without these sections would continue to work unchanged.
