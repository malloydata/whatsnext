# WN 0019 - Malloy Filter Operator

- **Status**: _Draft_
- **Discussions-To:** _slack_ or _malloymates_
- **Author:** Jason Smart \<jlsmart@meta.com>
- **Experiment-ID:** _none_

# Motivation

Today the Malloy language can handle a wide range of queries, including complex filtering via ranges, set comparisons, and regular expressions. Malloy's filters are documented in [docs.malloydata.dev/documentation/language/filters](https://docs.malloydata.dev/documentation/language/filters).

In order to provide a richer array of filtering options for numbers, string, dates, and booleans, we propose adding a new `f'<filter_string>'` expression to the language. The `filter_string`, detailed below, will add a rich language of choice to Malloy, providing a way to construct powerful filtering expressions, but with stricter typing and safety than naked regular expressions or raw SQL.

Filters are motivated by Looker filter expressions, [looker/docs/filter-expressions](https://cloud.google.com/looker/docs/filter-expressions), and indeed will be familiar to any data engineer who has used Looker, or even SQL `where` expressions.

The parser and serializer package (`malloy-filter`) is lightweight, with no dependencies. It will be incorporated into both the Malloy compiler (https://github.com/malloydata/malloy) and into the Malloy visual query builder. It produces a concise, lightweight intermediate representation (IR), see the examples below.

# Design

The filter operator will have the following format:

```code
~f'filter_string'
```

## Malloy Examples

<span style="font-family: monospace;">
dimension: is_recent is created_at <span style="background-color: lightgreen">~f'3 weeks ago'</span>
<br>
run: actions -> action_summary + { where: error_code <span style="background-color: lightgreen">~ f"NULL,No Error"</span> }
</span>

## Filter String Examples

Here are a few `filter_string` examples. For a more exhaustive list, see [SAMPLES.md](https://github.com/malloydata/malloy-filter/blob/main/SAMPLES.md).

```code
APPLE,ORANGE          # match "APPLE" or "ORANGE"
A%LE	                # starts with an "A" and ends with "LE", matches APPLE
-APPLE,-ORANGE        # not equal to either "APPLE" or "ORANGE"
APPLE,NULL            # matches "APPLE" or is NULL
TRUE                  # Boolean true
FALSE                 # Boolean false
NULL                  # Boolean NULL
-NULL                 # Boolean NOT NULL
THIS MONTH            # Date and time
3 DAYS AGO            # Date and time
BEFORE 3 DAYS AGO     # Date and time
2020-08               # Date and time
2025-08-30 12:00:00 to 2025-09-18 14:00:00
TODAY                 # Date and time
2025/05/10 for 3 days
3 months ago for 2 days
5                     # Numeric equals 5
!=5                   # Numeric not equals 5
1, 3, NULL, 5         # one of 1, 3, NULL, 5
NOT 1, 3, 5           # none of 1, 3, 5
-2.5 to 5.5           # >= -2.5 and <= 5.5
(.12e-20, 20.0e3]     # 1.2e-21 < x <= 20000
[0,10],[20,30]	      # 0 <= x <= 10 or 20 <= x <= 30
[0,10],20             # 0 <= x <= 10 or 20
```

# Sample Output

## Strings

```code
CAT,DOG

{
  operator: 'anyof',
  values: [ { operator: '=', value: 'CAT' }, { operator: '=', value: 'DOG' } ]
}
```

## Numbers

```code
-5.5 to 10

{
  startOperator: 'ge',
  startValue: -5.5,
  endOperator: 'le',
  endValue: 10
}
```

## Booleans

```code
null, false

{
  operator: 'anyof',
  values: [ { operator: 'NULL' }, { operator: 'FALSE' } ]
}
```

## Dates and Times

```code
after 2025-10-05

{
  values: [ { type: 'DATE', value: '2025-10-05' } ],
  prefix: 'AFTER'
}
```

# Implementation

The Typescript implementation is available on GitHub under `malloy-filter`: https://github.com/malloydata/malloy-filter/. The repo contains both filter parsers and serializers. Each class of filter (string, number, etc) is implementated as a separate parser, since the caller will know a-priori which type of filter is needed, based on context. The parsers will generate the intermediate representations (IRs) shown above. The serializers will convert the IRs back to filter strings.
