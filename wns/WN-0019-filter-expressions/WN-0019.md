# WN 0019 - Malloy Filter Operator

- **Status**: *Draft*
- **Discussions-To:**  _slack_ or _malloymates_
- **Author:** Jason Smaty \<jlsmart@meta.com>
- **Experiment-ID:** _none_

# Motivation
Today the Malloy language can handle a wide range of queries, including complex filtering via ranges, set comparisons, and regular expressions.  Malloy's filters are docuemnted in [docs.malloydata.dev/documentation/language/filters](https://docs.malloydata.dev/documentation/language/filters). 

In order to provide a richer array of filtering options for numbers, string, dates, and booleans, we propose adding a new `filter <fliter_string>` expression to the language.  The `filter_string`, detailed below, will add a rich language of choice to Malloy, providing a way to construct powerful filtering expressions, but with stricter typing and safety than naked regular expressions or raw SQL.

Moreover, we believe the filtering language described below is more intuitive – a syntax based on natural language.  Filters are motivated by Looker filter expressions, [looker/docs/filter-expressions](https://cloud.google.com/looker/docs/filter-expressions), and indeed will be familiar to any data engineer who has used Looker, or even SQL `where` expressions.

# Design

The filter operator will have the following format:

```code
filter “filter_string”
```

Here are a few examples.  Also see the comprehensive list of possibilities below.

```code
APPLE,ORANGE         # match "APPLE" or "ORANGE"
A%LE	             # starts with an "A" and ends with "LE", matches APPLE
-APPLE,-ORANGE       # not equal to either "APPLE" or "ORANGE"
this month
this week
after 2025-10-05
today	
tomorrow
2025/05/10 for 3 days
before 2025/05/10
2025/05
60 minutes	         # last 60 minutes
24 hours	         # last 24 hours
last 3 days
7 days from now
this week
2 years ago
yes, no, true, false  # booleans
NOT 5
!=5
1, 3, 5              # one of 1, 3, 5
NOT 1, 3, 5          # none of 1, 3, 5
-2.5 to 5.5
NOT 3000 to 8000
to 1000              # <= 1000
>100 AND <=200 OR 900
(5, 7)               # 5 < x < 7
(5, 7]               # 5 < x <= 7
[0,10],[20,30]	     # 0 <= x <= 10 OR 20 <= x <= 30
[0,10],20            # 0 <= x <= 10 OR 20
NOT (5,7)            # x <= 5 and x >= 7
```


The `filter_string` expressions can be one of the following, grouped by type:

## Strings

TBD

## Numbers

TBD

## Date and Time

TBD

## Booleans

TBD

## location filters?

TBD

# Implementation

We will develop both filter parsers and serializers.  We anticipate implementing separate parsers for each class of filter (string, number, etc), as the caller will know a-priori which type of filter is needed, based on context. The parsers will generate the intermediate representations (IRs) described in the table above.  The serializers will convert the IRs back to filter strings.

The parser and serializer package (`malloy-filter`) should be standalone, with minimal dependencies.  It will be incorporated into both the Malloy compiler (https://github.com/malloydata/malloy) and into the Malloy Explorer query builder @ Meta.  Moreover, it should produce a lightweight, concise IR.

