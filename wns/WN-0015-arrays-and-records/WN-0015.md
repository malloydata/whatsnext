# WN 0015 - Arrays and Records

- **Status**: *Draft*
- **Discussions-To:**  [Slack/malloy-language](https://malloy-community.slack.com/archives/C06JR0C23RB/p1722981665815069)
- **Author:** Michael Toy\<michaeltoy@meta.com>
- **Experiment-ID:** _NOID_YET_

# Record operations

A record is a set of key value pairs. As a table column a record is treated exactly like
a one-to-one join is in Malloy.

| Expression | Meaning |
| --- | --- |
| `recordField` | Mostly for `select:`, the entire field |
| `recordField.componentName` | The `componentName` field in the record |

## Typing

Record types are written `<id:type1, id:type2, id:type3 ..., id:typen>` for example
`<firstName: string, lastName: string, age: number>`

# Array Operations

## Brace Syntax Operations
There is use of `[]` syntax to provide based access and slicing of arrays.

| Expression | Meaning |
| --- | --- |
| `arrayObj` | The entire array as an object |
| `arrayObj[0]` | The first element of the array |
| `arrayObj[n]` | The element at index `n` in the array |
| `arrayObj[...]` | The last element of the array |
| `arrayObj[n to p]` | Range based slice, starting a index `n` and ending at `p` |
| `arrayObj[n, x]` | Slice starting at index `n` for length `x` |
| `arrayObj[n...]` | Slice starting at `n` and going to the end |
| `[n1, n2, n3]` | Literal for an array with three elements |

### Other syntactic support

One can imagine other uses of expressions (instead of functions) on array operations ...
maybe even if we like some of those, they don't go in the MVP. Here are just a few
examples off of the top of my head.

| Expression | Meaning |
| --- | --- |
| `x + y` | Concatenate the X and the Y array |
| `[ ...x, nel ]` | An array with all the elements of `x` and with one element added at the end |
| `x = [ 2, 3 ]` | True if x equals the array `[2,3]` |
| `x ~ [ 2, 3 ]` | True if x contains the sub-array `[2,3]` |
| `x ~ 2` | True if x contains `2` |


## Function Operations

There is a set of functions which take arrays as arguments which Malloy provides
translations for in every dialect.

MVP proposal is these are simply functions in the Malloy function library.

> Note: It has been suggested to extend the syntax of Malloy to allow a
> method like invocation `objName.split(seperator)`. This feels like
> an an entire new can of worms because we would want to make sure
> this could be implemented and didn't introduce new namespace problems
> since this would be yet another use of the increasingly ambiguous
> dot operator.

I am not sure which of these are essential. I have yet to do a survey of arrays
in all databases to see what capabilities they have. I have started with common
array operations in computer languages, maybe not all of these make sense
for database arrays.

> Note: It also isn't clear if it will be confusing to SQL people that some array
> operations are supported in `[]` syntax and some are in functions. We still
> don't have firm clarity on what it is OK to ask SQL users to learn.

| Function | Meaning |
| --- | --- |
| `split(string, seperator)` | Split a string into an array, using the separator |
| `join(array, seperator)` | Join an array of strings into a string, using the separator |
| `findFirst(array, element)` | Look for the element in the array from the beginning, return the index |
| `findLast(array, element)` | Look for the element in the array from the end, return the index |
| `push(array, element)` | Add a new element to the end of an array |
| `concat(array, array)` | Make a new array from two arrays |

> Note: Names are not important at this point, the operations list for which we need
> names is more important at this stage than what we call the operations.


## Arrays of Records

An array of records in Malloy is treated exactly like a one to many join. An access of a field
in a record `arrayName.recFieldName` implies and un-nesting of that record and subsequent
expansion of the query, just as a reference a field of a one join would.

Similarly, when doing aggregation, the aggregation context is specified with the
field name path, as in `arrayName.recFieldName.sum()`

## Arrays of Scalars

These present a syntactic conundrum, we would like these to work like joins, and like arrays of records, but we need a way to tell a reference to the entire object from a reference which un-nests the array and accesses the value. Currently Malloy uses `.value` as a pseudo-field which
is recognized as a un-nesting reference.

* Has the advantage of keeping the syntax similar between joins, record arrays, and scalar arrays.
* Has the dis-advantage of being unlike how objects are accessed from an array in an other programming context.

I originally wanted a non dot-based syntax for the un-nest gesture, C-like syntax might be `*arrayName` to mean "a thing in the array, not the whole array".

There is disagreement about this.

## Typing

Array types are written `TYPENAME[]` for example, `string[]` or `<firstName: string, lastName: string, age: number>[]`